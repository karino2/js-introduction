---
title: "第十二回: 簡単なプラグインのコードを読んでみよう"
layout: page
---

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.35.0/codemirror.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.35.0/codemirror.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.35.0/mode/javascript/javascript.js"></script>
<style>
    .CodeMirror { height: auto; border: 1px solid #ddd; }
    .console { border: 1px solid #333; color: rgb(48, 68, 216); padding: 0px 5px 0px 5px; }

    .answer {color: red;  }
    .hideanswer { display: none; }
    .result {font-size: large;}
    .wrong {color: red;  }
    .correct {color: rgb(0, 89, 255);  }



    .column{
        padding: 0.5em 1em;
        margin: 2em 0;
        color: #5d627b;
        background: white;
        border-top: solid 5px #5d627b;
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.22);
    }    
</style>
<link rel="stylesheet" href="https://rawgit.com/karino2/js-introduction/master/scripts/smoke.css" />
<script src="https://rawgit.com/karino2/js-introduction/master/scripts/smoke.min.js"></script>                    
<script src="https://neil.fraser.name/software/JS-Interpreter/acorn_interpreter.js"></script>

<script type="text/javascript" src="https://rawgit.com/karino2/js-introduction/master/scripts/env.js"></script>



<script>
var questions = [];


document.body.onload = function() {
  initInterpreter();


  setupAllREPL2(4);
  setupAllQuestionsWithScnario(questions);
}
</script>

（たぶん）最終回です。

第十二回は、おまけとして、実際のツクールMVのプラグインのうち簡単そうな奴を読んで行こう、という回になります。
前回まではツクールMVと関係無い一般的なJavaScriptの話でしたが、今回だけはツクールMV特有の話です。
自分はツクールMVは素人なのでツクールMV自体の話はあんま信用せずに読んで下さい。あくまでプログラムの解説の方がメインという事で。

実際のコードには、説明して無い事や良く分からない複雑な部分などが出てくるものです。
JavaScriptの本と実際のコードには結構いろいろギャップがあって、初めて見る時には苦戦する事になると思います。

今回はプラグインのコードを読んで行きつつ、これまで説明が漏れていた事について補足していったり、読まなくて良い部分はどの辺か、
みたいな事を語っていきたいと思います。

なお、あまり今回は実行してみるコードは用意出来ないので、自分で街頭するプラグインを実際に動かしてみながら説明を読んでくれると理解が増すと思います。

# 一番簡単なプラグイン

自分はツクールMVは素人なので、「ツクールMV プラグイン 入門」とかで適当にググって当たったサイトから簡単そうなのを選んでみます。

自分がちらっと見た範囲だと一番簡単なのはこちらのサイトでした。[プラグイン開発Wiki - RPGツクールMV](https://www65.atwiki.jp/rpgmvpl/pages/12.html)


最初はこちらのサイトのプラグインから読んで行きましょう。

## まずはコードから

今回はプラグインの仕組みとかそういう話はあまりせずに、コードの方だけ見ていきます。
パラメータとかその辺の事は入門サイトで勉強してください。

さて、コードを転載すると以下のようでした。

```
(function(){
	var _Game_Interpreter_pluginCommand =
		Game_Interpreter.prototype.pluginCommand;

	Game_Interpreter.prototype.pluginCommand = function(command, args)
	{
		_Game_Interpreter_pluginCommand.call(this, command, args);

		if( command === 'test_pl' )
			$gameMessage.add( "プラグインが呼び出されたよ☆" );
	};
})();
```

この一行目と最後の行は、[前回](ch11.md)やった、関数を作ってすぐ実行する、という奴でした。
この中の変数が他とぶつからない為のトリックなのですが、動作を知りたいだけならあまり気にしなくて良い。

取り除くとこうなります。(行のはじめの空白はうっとうしいのでついでに削ります)

```
var _Game_Interpreter_pluginCommand =
    Game_Interpreter.prototype.pluginCommand;

Game_Interpreter.prototype.pluginCommand = function(command, args)
{
    _Game_Interpreter_pluginCommand.call(this, command, args);

    if( command === 'test_pl' )
        $gameMessage.add( "プラグインが呼び出されたよ☆" );
};
```

ちょっとvarで用意している変数の名前が長いので、少し短くしましょう。
これはもともとの関数なのでmotomotoという名前にします（後で何がもともとなのかは説明します）。


```
var motomoto =
    Game_Interpreter.prototype.pluginCommand;

Game_Interpreter.prototype.pluginCommand = function(command, args)
{
    motomoto.call(this, command, args);

    if( command === 'test_pl' )
        $gameMessage.add( "プラグインが呼び出されたよ☆" );
};
```

さて、このコードを順番に見ていきましょう。

## まず元の関数を変数に入れる

最初の二行をまず見てみます。

```
var motomoto =
    Game_Interpreter.prototype.pluginCommand;
```

`Game_Inpterpreter`というのはツクールMVが用意してくれている辞書で、
その中のprototypeも辞書です。
prototypeは少し特殊で詳細は解説しませんが、その前の辞書名と合わせて全体で辞書の名前だと思っておくと9割はOK。

つまりこの場合、`Game_Interpreter.prototype`全部でツクールMVが提供している辞書だと思っておきましょう。

この`なんちゃら.prototype`という辞書には、関数をいろいろ入れる決まりになっています。
という事で入っているのはだいたい関数です。

ここでは、この`なんちゃら.prototype`という辞書の中の`pluginCommand`というのを取り出しています。
これが辞書のキーな訳ですね。辞書のキーは[第六回](ch06.md)を参考にしてください。


**Game_Interpreter.prototype辞書**

| キー | 中身 |
|----- | ---- |
| pluginCommand | 元から入っている何かの関数 |

このテーブルの、「元から入っている何かの関数」というのを取り出して、`motomoto`に入れている訳です。

## 関数を差し替えている所のコードを見る

続きのコードを見てみましょう。以下のようになっています。

```
Game_Interpreter.prototype.pluginCommand = function(command, args)
{
    motomoto.call(this, command, args);

    if( command === 'test_pl' )
        $gameMessage.add( "プラグインが呼び出されたよ☆" );
};
```

ちょっと構造に注目する為、functionの中を...で置き換えてしまいましょう。

```
Game_Interpreter.prototype.pluginCommand = function(command, args)
{
    ...
};
```

こうすると、先ほどの`なんちゃら.prototype`という辞書に、pluginCommandというキーで新しい関数を入れている事が分かります。
これは先ほど取り出した辞書と同じ辞書ですね。

つまり以下のような辞書にしている訳です。

**Game_Interpreter.prototype辞書**

| キー | 中身 |
|----- | ---- |
| pluginCommand | 今作ってる関数 |


JavaScriptの大規模なプログラムでは、関数を辞書に入れた物をいろいろ集めて最終的なゲームなどを作ります。ツクールMVもそのように作られています。

そしてプラグインというのは、この特定の部分の辞書を上書きして自分の関数に差し替えて、自分の望む処理を挟み込む、というのが基本となります。

どういう辞書があって何を差し替えると何が出来るのか、というのはツクールMVの環境の知識となるので私も知りません。
正しくは公式のドキュメントを読む事になるのでしょうが、英語っぽいですね。
最初のうちはプラグインの入門サイトを見たり他人のプラグインを調べたりして覚えていくのが良さそうです。

さて、今回は`Game_Intepreter.prototype`という所の関数を差し替えるみたいです。
このpluginCommandというのは、上記のサイトから推測するとゲーム中に「プラグインコマンド」というのを実行する事が出来るみたいですね。
私は良く知りませんが、読者の方がむしろ知っている所かもしれません。

この「プラグインコマンド」というのを実行すると、この`Game_Intepreter.prototype`という辞書のpluginComamndというキーの物が実行されるみたいです。

だからこの関数を自分の関数にしてしまえば、この「プラグインコマンド」というのが実行された時に自分の書いたコードが実行されるように出来ます。（たぶん）

## 差し替えた関数の中身を見る

では入れている関数の中身を見てみましょう。以下のようになっていました。

```
Game_Interpreter.prototype.pluginCommand = function(command, args)
{
    motomoto.call(this, command, args);

    if( command === 'test_pl' )
        $gameMessage.add( "プラグインが呼び出されたよ☆" );
};
```

最初の行はもう見たので、イコールより左側は見やすくする為に削っておきます。
すると辞書に入れる関数は以下のようになっています。

```
function(command, args)
{
    motomoto.call(this, command, args);

    if( command === 'test_pl' )
        $gameMessage.add( "プラグインが呼び出されたよ☆" );
};
```

`function(command, args)`というのは[前回](ch11.html)やった **関数の文字や数字の受け取り方** というあたりの話で、
以下と同じ意味になるのでした。

```
function() {
    var command = arguments[0];
    var args = arguments[1];
```

その次の行はちょっと新しい。

```
    motomoto.call(this, command, args);
```

ここで`call`という物が出てきます。これは関数を、「thisを偽造して実行する」という特別な命令です。
あとで細かく説明しますが、現時点では通常の関数を使う以下のようなコードと、

```
motomoto(command, args);
```

それを以下のようにしたコードは

```
motomoto.call(偽造したい辞書, command, args);
```

ほとんど同じ内容と思ってください。

さて、このmotomotoというのは何かといえば、最初に`Game_Interpreter.prototype`辞書に入っていた関数を取り出して入れておいた変数でした。
以下みたいなコードでしたね。

```
var motomoto =
    Game_Interpreter.prototype.pluginCommand;
```

つまり、もともとからあった関数をこのmotomotoに退避しておいて、自分の関数を新しくこの`Game_Interpreter.prototype.pluginCommand`に差し替えているのです。

そして、この差し替えた関数の中でもともとの関数を呼んでいる。例えるなら、もともとの執事セバスチャンとは別に、その兄弟のパトリックという執事が居て、
パトリックに頼むとセバスチャンにただ用事を言いつける、みたいな状態になる訳です。
motomotoにはセバスチャンが入っている訳ですね。

さて、また関数の中身に戻ります。

```
function(command, args)
{
    motomoto.call(this, command, args);

    if( command === 'test_pl' )
        $gameMessage.add( "プラグインが呼び出されたよ☆" );
};
```

`motomoto.call`は今説明した通り前から居た執事に同じ用事を言いつける、という事になるのですが、
そのあとが新しくパトリックがやる事になります。

```
    if( command === 'test_pl' )
        $gameMessage.add( "プラグインが呼び出されたよ☆" );
```

最初のif文ではイコールが三つありますが`===`、これはかっこつけた書き方で、`==`と同じと思ってください。
commandというのが何かはツクールMV側の資料を調べないと分かりませんが、たぶんプラグインの名前が入っているっぽい？
この辺は私はプラグインコマンドというのが何なのか良く分かってないので推測です。

推測していじってみて動かし、結果を見てあってたかどうかを確認しながら理解を深めていくのが初期のやり方なので、こんな感じで分からない事は適当に推測して進めます。

プラグインコマンドの`command`が`"test_pl"`という文字だったら、このifの次の行を実行する、という意味になっています。
このシリーズではifの後には`{}`を付けてましたが、一行だけならつけなくても良い、という特別ルールがあります。

つまり、

```
    if( command === 'test_pl' )
        $gameMessage.add( "プラグインが呼び出されたよ☆" );
```

と

```
    if( command === 'test_pl' ){
        $gameMessage.add( "プラグインが呼び出されたよ☆" );
    }
```

は全く同じ意味です。違いが気にならないなら気にしなくてもOK。気になる人向けに説明してみました。
なお、自分で書く時はこれまでやった通り、いつも下のように書きましょう。（理由は秘密、私を信じて！）

で、そのifの実行される文。
`$gameMessage.add()`というのはゲームのメッセージウィンドウにメッセージを出すっぽいですね。
この講座でやっていた`MessageBox.show()`と似た物と言えそうです。

つまり全体としては、

1. もともとの関数を呼び出す（前の執事に用事を言いつける）
2. `command`が`"test_pl"`だったら、メッセージを表示する

という事をやるプラグインのようです。

以上でこのプラグインの基本は理解出来た事になります。どうでしょう？簡単？難しい？結局の所`function`の中以外はお約束みたいな物なので、
本当に重要なのはif文の所だけだったりします。これならこのシリーズをここまでやった人にとってはどうって事無いんじゃないでしょうか。

さて、ここで少し、callについて説明をしておきましょう。


## callを使った関数の差し替え

プラグインでは、セバスチャンを用済みにしてパトリックに差し替えて我々のやりたい事をやらせて、
これまでの仕事はパトリックがセバスチャンに頼む、というパターンが多く出現します。

お嬢様はパトリックに頼むだけなのでやる事は変わってないのですが、パトリック側が前の執事をこっそり使っている、という訳です。

これは何度も出てくるので、パターンとして覚えてしまう方が読むのがぐっと楽になります。

### thisの復習から

thisは、関数が今入っている辞書を意味します。
例えば以下のようなコードです。

<div id="ex1">
<input type="button" value="実行" />
<textarea>
var kumosaba = {name: "雲鯖", users:["るーしー", "あじゃ"]};
var mosssaba = {name: "モス鯖", users:["じゃがしー", "ダニキ"]};

function tansu() {
    MessageBox.show(this.name + arguments[0]);
}

// kumosabaに入れて呼ぶ
kumosaba.nakigoe = tansu;
kumosaba.nakigoe("です！");

// mosssabaに入れて呼ぶ
mosssaba.nakigoe = tansu;
mosssaba.nakigoe("だにゃ！");</textarea>
<b>結果:</b> <span class="console"></span><br>
</div>
  
　  
このように関数自体は同じtansuでも、kumosabaに入っているかmosssabaに入っているかで、thisの値が変わります。

### callでthisを偽造する

上のコードを、callを使う事で、実際には辞書に入れずに、辞書に入っているフリをさせる事が出来ます。

<div id="ex2">
<input type="button" value="実行" />
<textarea>
var kumosaba = {name: "雲鯖", users:["るーしー", "あじゃ"]};
var mosssaba = {name: "モス鯖", users:["じゃがしー", "ダニキ"]};

function tansu() {
    MessageBox.show(this.name + arguments[0]);
}


// thisをkumosabaだと偽って呼ぶ
tansu.call(kumosaba, "です！");

// thisをmosssabaだと偽って呼ぶ
tansu.call(mosssaba, "だにゃ！");</textarea>
<b>結果:</b> <span class="console"></span><br>
</div>
  
　  
このように、関数の中のcallというのを使うと、`thisを偽りつつ関数を実行する`という事が出来ます。
なお、callに渡す一つ目は辞書となり、二つ目からが関数に実際に渡す物になります。

`arguments[0]`は、下のコードの例だと

```
tansu.call(kumosaba, "です！");
```

一つ目では無く、二つ目の`"です！"`になります。

### callを使って関数を差し替える

さて、このcallを使って、自分の処理をはさみこむ、というのがプラグインでは良くあります。

例えば以下のようなコードがあったとします。

<div id="ex3">
<input type="button" value="実行" />
<textarea>
var awa = {nakigoe: "むぇー",
    naku: function(){
        MessageBox.show(this.nakigoe);
    }
};

awa.naku();</textarea>
<b>結果:</b> <span class="console"></span><br>
</div>
  
　  
この時に、nakuを別の関数に差し替えたいとする。
で、元の関数を変数にとっておいて呼ぶと、thisの値が変わるので、エラーになります。やってみましょう。

<div id="ex4">
<input type="button" value="実行" />
<textarea>
var awa = {nakigoe: "むぇー",
    naku: function(){
        MessageBox.show(this.nakigoe);
    }
};

var motomoto = awa.naku;
motomoto();</textarea>
<b>結果:</b> <span class="console"></span><br>
</div>
  
　  
`motomoto()`を実行する時には、これはどこの辞書にも入ってない状態で直接実行しているので、thisは何もさしてない、という特殊な状態になります（ここは込み入った事情があるので細かい解説はしません）。

だから、`awa.naku`に入ってた関数が`this.nakigoe`を使おうとすると、thisは空なのでnakigoeなんて無い！と怒られる訳です。
